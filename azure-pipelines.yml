trigger:
- main

variables:
- group: mini-netflix-secrets

# Use your self-hosted agent pool
pool:
  name: Default  # Replace with your self-hosted agent pool name

stages:
- stage: BuildAndDeploy
  displayName: Build Docker Image & Deploy to Minikube
  jobs:
  - job: BuildDeployJob
    displayName: Build & Deploy Auth Service
    steps:
    - checkout: self

    # Step 1: Build Docker image
    - task: PowerShell@2
      displayName: Build Docker Image
      inputs:
        targetType: inline
        script: |
          Write-Host "Building Docker image..."
          docker build -t auth-image:latest .

    # Step 2: Start Minikube (Windows version)
    - task: PowerShell@2
      displayName: Start Minikube
      inputs:
        targetType: inline
        script: |
          Write-Host "Starting Minikube..."
          minikube start --driver=docker

    # Step 3: Apply Kubernetes manifests
    - task: PowerShell@2
      displayName: Deploy to Kubernetes
      inputs:
        targetType: inline
        script: |
          Write-Host "Deploying auth service to Kubernetes..."
          kubectl apply -f k8s/auth-deployment.yml
          kubectl apply -f k8s/auth-service.yml

    # Step 4: Check pods status
    - task: PowerShell@2
      displayName: Check Kubernetes Pods
      inputs:
        targetType: inline
        script: |
          kubectl get pods
          kubectl get svc
